<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motion Video Player (Brightness Detection)</title>
<style>
  body { margin: 0; background: black; overflow: hidden; }
  video#player { width: 100vw; height: 100vh; object-fit: cover; }

  /* Camera must be visible (1px) for iOS to update frames */
  #cam {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 1px;
    height: 1px;
    opacity: 0.01; /* must NOT be 0 */
    pointer-events: none;
  }

  /* Debug overlay */
  #debug {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.6);
    color: #0f0;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
    border-radius: 6px;
    z-index: 9999;
  }

  /* Motion dot indicator */
  #motionDot {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: red; /* default: no motion */
    border: 2px solid #fff;
    z-index: 9999;
  }
</style>
</head>
<body>

<div id="debug">Initializing…</div>
<div id="motionDot"></div>

<video id="cam" autoplay playsinline></video>

<video id="player" playsinline preload="auto" muted>
  <source src="yourvideo.mp4" type="video/mp4">
</video>

<script>
const cam = document.getElementById('cam');
const player = document.getElementById('player');
const debug = document.getElementById('debug');
const motionDot = document.getElementById('motionDot');

let lastBrightness = null;
let motionTimer = null;

navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
  .then(stream => cam.srcObject = stream)
  .catch(err => alert("Camera access failed: " + err));

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

player.load();

const THRESHOLD = 5;  // VERY sensitive for iPad

function detectMotion() {
  if (cam.videoWidth === 0) {
    debug.innerText = "Waiting for camera…";
    requestAnimationFrame(detectMotion);
    return;
  }

  canvas.width = cam.videoWidth;
  canvas.height = cam.videoHeight;

  ctx.drawImage(cam, 0, 0);
  const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

  // Compute average brightness
  let total = 0;
  for (let i = 0; i < frame.data.length; i += 4) {
    const r = frame.data[i];
    const g = frame.data[i+1];
    const b = frame.data[i+2];
    total += (r + g + b) / 3;
  }
  const brightness = total / (frame.data.length / 4);

  let diff = 0;
  if (lastBrightness !== null) {
    diff = Math.abs(brightness - lastBrightness);

    debug.innerText =
      "Brightness: " + brightness.toFixed(2) + "\n" +
      "Diff: " + diff.toFixed(5) + "\n" +
      "Threshold: " + THRESHOLD + "\n" +
      (diff > THRESHOLD ? "MOTION DETECTED" : "no motion");

    if (diff > THRESHOLD) {
      motionDot.style.background = "lime"; // turn green
      player.play();
      clearTimeout(motionTimer);
      motionTimer = setTimeout(() => {
        player.pause();
        motionDot.style.background = "red"; // back to red
      }, 3000);
    } else {
      motionDot.style.background = "red";
    }
  }

  lastBrightness = brightness;
  requestAnimationFrame(detectMotion);
}

detectMotion();
</script>

</body>
</html>
