<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Full-screen iOS Web App -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="MotionFrame">

<title>Motion Video Frame</title>

<style>
  body { margin: 0; background: black; overflow: hidden; transition: opacity 0.5s ease; }
  video#player { width: 100vw; height: 100vh; object-fit: cover; }

  /* Camera must be visible (1px) for iOS to update frames */
  #cam {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 1px;
    height: 1px;
    opacity: 0.01;
    pointer-events: none;
  }

  /* Debug overlay */
  #debug {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.6);
    color: #0f0;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
    border-radius: 6px;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  /* Motion dot */
  #motionDot {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: grey;
    border: 2px solid #fff;
    z-index: 9999;
  }
</style>
</head>
<body>

<div id="debug">Initializingâ€¦</div>
<div id="motionDot"></div>

<video id="cam" autoplay playsinline></video>

<video id="player" playsinline preload="auto" muted loop>
  <source src="yourvideo.mp4" type="video/mp4">
</video>
<script>
const cam = document.getElementById('cam');
const player = document.getElementById('player');
const debug = document.getElementById('debug');
const motionDot = document.getElementById('motionDot');

let lastBrightness = null;
let sleepTimer = null;
let idlePauseTimer = null;
let sleeping = false;

const THRESHOLD = 5;
const IDLE_PAUSE_TIME = 7000; // 7 seconds
const SLEEP_DELAY = 10 * 60 * 1000; // 10 minutes

// Hide debug after 5 seconds
setTimeout(() => { debug.style.opacity = "0"; }, 5000);

// Start camera
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
  .then(stream => cam.srcObject = stream)
  .catch(err => alert("Camera access failed: " + err));

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

player.load();
player.play();

// Reset idle pause timer
function resetIdlePause() {
  clearTimeout(idlePauseTimer);
  idlePauseTimer = setTimeout(() => {
    player.pause();
  }, IDLE_PAUSE_TIME);
}

// Sleep mode
function goToSleep() {
  sleeping = true;
  player.pause();
  document.body.style.opacity = "0.1"; // dim screen
  motionDot.style.background = "grey";
}

// Wake mode
function wakeUp() {
  if (!sleeping) return;
  sleeping = false;

  document.body.style.opacity = "1"; // restore brightness
  player.play();
  resetIdlePause();
}

// Reset sleep timer
function resetSleepTimer() {
  clearTimeout(sleepTimer);
  sleepTimer = setTimeout(goToSleep, SLEEP_DELAY);
}

// Motion detection loop
function detectMotion() {
  if (cam.videoWidth === 0) {
    requestAnimationFrame(detectMotion);
    return;
  }

  canvas.width = cam.videoWidth;
  canvas.height = cam.videoHeight;

  ctx.drawImage(cam, 0, 0);
  const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

  let total = 0;
  for (let i = 0; i < frame.data.length; i += 4) {
    total += (frame.data[i] + frame.data[i+1] + frame.data[i+2]) / 3;
  }
  const brightness = total / (frame.data.length / 4);

  if (lastBrightness !== null) {
    const diff = Math.abs(brightness - lastBrightness);

    if (diff > THRESHOLD) {
      motionDot.style.background = "lime";
      wakeUp();
      player.play();
      resetIdlePause();
      resetSleepTimer();
    } else {
      motionDot.style.background = "grey";
    }
  }

  lastBrightness = brightness;
  requestAnimationFrame(detectMotion);
}

resetIdlePause();
resetSleepTimer();
detectMotion();

// Wake on touch
window.addEventListener("touchstart", wakeUp);
</script>

</body>
</html>
