<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Full-screen iOS Web App -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="MotionFrame">

<title>Motion Video Frame</title>

<style>
  body {
    margin: 0;
    background: black;
    overflow: hidden;
    transition: opacity 0.5s ease;
    font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  }

  video#player {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
  }

  #cam {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 1px;
    height: 1px;
    opacity: 0.01;
    pointer-events: none;
  }

  #debug {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.6);
    color: #0f0;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
    border-radius: 6px;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  #motionDot {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: grey;
    border: 2px solid #fff;
    z-index: 9999;
  }

  #settingsPanel {
    position: fixed;
    top: 0;
    right: -280px;
    width: 260px;
    height: 100vh;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 16px;
    box-sizing: border-box;
    z-index: 10000;
    border-radius: 16px 0 0 16px;
    box-shadow: -4px 0 12px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    gap: 12px;
    transition: right 0.3s ease;
  }

  #settingsPanel.open {
    right: 0;
  }

  #settingsPanel h2 {
    margin: 0 0 8px;
    font-size: 18px;
  }

  #settingsPanel h3 {
    margin: 12px 0 4px;
    font-size: 14px;
    opacity: 0.9;
  }

  #settingsPanel label {
    font-size: 13px;
    display: block;
    margin-bottom: 4px;
  }

  #settingsPanel input[type="range"] {
    width: 100%;
  }

  #settingsPanel .row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
  }

  #settingsPanel button {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    background: #444;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 13px;
  }

  #settingsPanel button:active {
    background: #666;
  }

  #settingsPanel .toggleRow {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
  }

  #calibrationStatus {
    font-size: 11px;
    opacity: 0.8;
  }
</style>
</head>
<body>

<div id="debug">Initializing…</div>
<div id="motionDot"></div>

<video id="cam" autoplay playsinline></video>

<!-- Updated: no loop, no source tag -->
<video id="player" playsinline preload="auto" muted></video>

<!-- Settings panel -->
<div id="settingsPanel">
  <h2>Settings</h2>

  <h3>Motion sensitivity</h3>
  <label>Lower = more sensitive</label>
  <input id="motionThresholdSlider" type="range" min="2" max="20" value="5">
  <div class="row">
    <span>Sensitive</span>
    <span id="motionThresholdValue">5</span>
  </div>

  <h3>Idle pause duration</h3>
  <label>Seconds before video auto‑pauses</label>
  <input id="idlePauseSlider" type="range" min="3" max="60" value="7">
  <div class="row">
    <span>3s</span>
    <span id="idlePauseValue">7s</span>
  </div>

  <h3>Sleep timer</h3>
  <label>Minutes with no motion before dim</label>
  <input id="sleepTimerSlider" type="range" min="1" max="30" value="10">
  <div class="row">
    <span>1 min</span>
    <span id="sleepTimerValue">10 min</span>
  </div>

  <h3>Display</h3>
  <div class="toggleRow">
    <span>Show debug overlay</span>
    <input id="debugToggle" type="checkbox">
  </div>
  <div class="toggleRow">
    <span>Show motion dot</span>
    <input id="motionDotToggle" type="checkbox" checked>
  </div>

  <h3>Video Selection</h3>
  <div class="toggleRow">
    <span>Play Video 1</span>
    <input id="video1Toggle" type="checkbox" checked>
  </div>
  <div class="toggleRow">
    <span>Play Video 2</span>
    <input id="video2Toggle" type="checkbox">
  </div>
  <div class="toggleRow">
    <span>Play Video 3</span>
    <input id="video3Toggle" type="checkbox">
  </div>

  <h3>Pause Mode</h3>
  <div class="toggleRow">
    <span>Idle Pause Mode</span>
    <input id="pauseModeIdle" type="radio" name="pauseMode" checked>
  </div>
  <div class="toggleRow">
    <span>Full Cycle Pause Mode</span>
    <input id="pauseModeFull" type="radio" name="pauseMode">
  </div>

  <h3>Calibration</h3>
  <button id="calibrateButton">Run calibration</button>
  <div id="calibrationStatus">Not calibrated yet</div>

  <button id="resetDefaultsButton">Reset to defaults</button>
</div>

<script>
const cam = document.getElementById('cam');
const player = document.getElementById('player');
const debug = document.getElementById('debug');
const motionDot = document.getElementById('motionDot');
const settingsPanel = document.getElementById('settingsPanel');

const motionThresholdSlider = document.getElementById('motionThresholdSlider');
const motionThresholdValue = document.getElementById('motionThresholdValue');
const idlePauseSlider = document.getElementById('idlePauseSlider');
const idlePauseValue = document.getElementById('idlePauseValue');
const sleepTimerSlider = document.getElementById('sleepTimerSlider');
const sleepTimerValue = document.getElementById('sleepTimerValue');
const debugToggle = document.getElementById('debugToggle');
const motionDotToggle = document.getElementById('motionDotToggle');

const video1Toggle = document.getElementById('video1Toggle');
const video2Toggle = document.getElementById('video2Toggle');
const video3Toggle = document.getElementById('video3Toggle');

const pauseModeIdle = document.getElementById('pauseModeIdle');
const pauseModeFull = document.getElementById('pauseModeFull');

const calibrateButton = document.getElementById('calibrateButton');
const calibrationStatus = document.getElementById('calibrationStatus');
const resetDefaultsButton = document.getElementById('resetDefaultsButton');

let lastBrightness = null;
let sleepTimer = null;
let idlePauseTimer = null;
let sleeping = false;
let settingsOpen = false;

let THRESHOLD = 5;
let IDLE_PAUSE_TIME = 7000;
let SLEEP_DELAY = 10 * 60 * 1000;

let playlist = ["yourvideo.mp4"];
let currentVideoIndex = 0;
let FULL_CYCLE_MODE = false;

setTimeout(() => { debug.style.opacity = "0"; }, 5000);

navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
  .then(stream => cam.srcObject = stream)
  .catch(err => alert("Camera access failed: " + err));

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

function playNextVideo() {
  currentVideoIndex = (currentVideoIndex + 1) % playlist.length;
  player.src = playlist[currentVideoIndex];
  player.play();
}

player.addEventListener("ended", () => {
  if (FULL_CYCLE_MODE) {
    if (currentVideoIndex === playlist.length - 1) {
      player.pause();
      return;
    }
  }
  playNextVideo();
});

function resetIdlePause() {
  clearTimeout(idlePauseTimer);
  idlePauseTimer = setTimeout(() => {
    if (!settingsOpen && !sleeping && pauseModeIdle.checked) {
      player.pause();
    }
  }, IDLE_PAUSE_TIME);
}

function goToSleep() {
  sleeping = true;
  player.pause();
  document.body.style.opacity = "0.1";
  motionDot.style.background = "grey";
}

function wakeUp() {
  if (!sleeping) return;
  sleeping = false;
  document.body.style.opacity = "1";
  player.play();
  resetIdlePause();
}

function resetSleepTimer() {
  clearTimeout(sleepTimer);
  sleepTimer = setTimeout(goToSleep, SLEEP_DELAY);
}

function detectMotion() {
  if (cam.videoWidth === 0) {
    requestAnimationFrame(detectMotion);
    return;
  }

  canvas.width = cam.videoWidth;
  canvas.height = cam.videoHeight;

  ctx.drawImage(cam, 0, 0);
  const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

  let total = 0;
  for (let i = 0; i < frame.data.length; i += 4) {
    total += (frame.data[i] + frame.data[i+1] + frame.data[i+2]) / 3;
  }
  const brightness = total / (frame.data.length / 4);

  if (lastBrightness !== null) {
    const diff = Math.abs(brightness - lastBrightness);

    if (diff > THRESHOLD) {
      if (motionDotToggle.checked) motionDot.style.background = "lime";
      wakeUp();
      if (!settingsOpen) {
        player.play();
        resetIdlePause();
      }
      resetSleepTimer();
    } else {
      if (motionDotToggle.checked) motionDot.style.background = "grey";
    }

    if (debugToggle.checked) {
      debug.style.opacity = "1";
      debug.textContent =
        `brightness: ${brightness.toFixed(2)} diff: ${diff.toFixed(2)} ` +
        `TH: ${THRESHOLD} idle: ${IDLE_PAUSE_TIME/1000}s sleep: ${SLEEP_DELAY/60000}m`;
    } else {
      debug.style.opacity = "0";
    }
  }

  lastBrightness = brightness;
  requestAnimationFrame(detectMotion);
}

function isInTopRightCorner(x, y) {
  const margin = 80;
  return (x > window.innerWidth - margin && y < margin);
}

function openSettings() {
  if (settingsOpen) return;
  settingsOpen = true;
  settingsPanel.classList.add('open');
  player.pause();
}

function closeSettings() {
  if (!settingsOpen) return;
  settingsOpen = false;
  settingsPanel.classList.remove('open');
}

let longPressTimer = null;

window.addEventListener('touchstart', (e) => {
  const touch = e.touches[0];
  if (!touch) return;
  const x = touch.clientX;
  const y = touch.clientY;

  if (isInTopRightCorner(x, y) && !settingsOpen) {
    longPressTimer = setTimeout(openSettings, 3000);
  } else if (isInTopRightCorner(x, y) && settingsOpen) {
    closeSettings();
  }
});

window.addEventListener('touchend', () => {
  clearTimeout(longPressTimer);
});

window.addEventListener('mousedown', (e) => {
  const x = e.clientX;
  const y = e.clientY;

  if (isInTopRightCorner(x, y) && !settingsOpen) {
    longPressTimer = setTimeout(openSettings, 3000);
  } else if (isInTopRightCorner(x, y) && settingsOpen) {
    closeSettings();
  }
});

window.addEventListener('mouseup', () => {
  clearTimeout(longPressTimer);
});

function applySettingsFromUI() {
  THRESHOLD = parseInt(motionThresholdSlider.value, 10);
  motionThresholdValue.textContent = THRESHOLD;

  const idleSeconds = parseInt(idlePauseSlider.value, 10);
  IDLE_PAUSE_TIME = idleSeconds * 1000;
  idlePauseValue.textContent = idleSeconds + "s";
  resetIdlePause();

  const sleepMinutes = parseInt(sleepTimerSlider.value, 10);
  SLEEP_DELAY = sleepMinutes * 60 * 1000;
  sleepTimerValue.textContent = sleepMinutes + " min";
  resetSleepTimer();

  debug.style.opacity = debugToggle.checked ? "1" : "0";
  motionDot.style.display = motionDotToggle.checked ? "block" : "none";

  playlist = [];
  if (video1Toggle.checked) playlist.push("yourvideo.mp4");
  if (video2Toggle.checked) playlist.push("yourvideo2.mp4");
  if (video3Toggle.checked) playlist.push("yourvideo3.mp4");

  if (playlist.length === 0) {
    playlist.push("yourvideo.mp4");
    video1Toggle.checked = true;
  }

  FULL_CYCLE_MODE = pauseModeFull.checked;
}

motionThresholdSlider.addEventListener('input', applySettingsFromUI);
idlePauseSlider.addEventListener('input', applySettingsFromUI);
sleepTimerSlider.addEventListener('input', applySettingsFromUI);
debugToggle.addEventListener('change', applySettingsFromUI);
motionDotToggle.addEventListener('change', applySettingsFromUI);
video1Toggle.addEventListener('change', applySettingsFromUI);
video2Toggle.addEventListener('change', applySettingsFromUI);
video3Toggle.addEventListener('change', applySettingsFromUI);
pauseModeIdle.addEventListener('change', applySettingsFromUI);
pauseModeFull.addEventListener('change', applySettingsFromUI);

calibrateButton.addEventListener('click', () => {
  calibrationStatus.textContent = "Calibrating… please hold still";
  calibrationStatus.style.opacity = "1";

  lastBrightness = null;
  setTimeout(() => {
    calibrationStatus.textContent = "Calibration complete";
  }, 2000);
});

resetDefaultsButton.addEventListener('click', () => {
  motionThresholdSlider.value = 5;
  idlePauseSlider.value = 7;
  sleepTimerSlider.value = 10;
  debugToggle.checked = false;
  motionDotToggle.checked = true;
  video1Toggle.checked = true;
  video2Toggle.checked = false;
  video3Toggle.checked = false;
  pauseModeIdle.checked = true;
  pauseModeFull.checked = false;
  calibrationStatus.textContent = "Defaults restored (not calibrated)";
  applySettingsFromUI();
});

applySettingsFromUI();

player.src = playlist[0];
player.load();
player.play();
resetIdlePause();
resetSleepTimer();
detectMotion();

window.addEventListener("touchstart", () => {
  if (sleeping) {
    wakeUp();
  }
});
</script>

<script>
  setInterval(() => {
    console.log("keepalive");
  }, 60000);
</script>

</body>
</html>
